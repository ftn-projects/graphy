{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Home</title>
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }


        body {
            width: 100%;
            height: 100vh;
        }

        .all-plugins-container {
            flex: 1;
            display: flex;
            flex-direction: row;
            border: 1px solid blue;
        }

        .main-plugin-container {
            flex: 1;
        }

        .vertical-plugin-container {
            display: flex;
            flex-direction: column;
        }

        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
        }

        .search-section-container {
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .tree-plugin-container {
            border: 1px solid forestgreen;
        }

        .bird-plugin-container {
            border: 1px solid lightskyblue;
        }

        .main-plugin-container {
            border: 1px solid black;
        }

        .tree-plugin-container, .bird-plugin-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 350px;
        }

        .bird-plugin-svg {
            width: 100%; /* Adjust width as needed */
            height: 100%; /* Adjust height as needed */
        }

    </style>
</head>
<body>
<script src="{% static 'js_observer.js' %}"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<div class="container">
    <div class="search-section-container">
        Hypothetical Search and Filter Section
    </div>
    <div class="all-plugins-container">
        <div class="vertical-plugin-container">
            <div class="tree-plugin-container">Hypothetical Tree View</div>
            <div class="bird-plugin-container">

            </div>
        </div>
        <div class="main-plugin-container">
            {{ plugin_content|safe }}
        </div>
    </div>
</div>
<script>
    visualizer_observer.attach(EventType.HTML_CHANGED, on_data_changed);

    function on_data_changed(event, data) {
        // Remove any existing minimap
        d3.select(".bird-plugin-container svg").remove();

        // Create a new SVG for the minimap
        var minimapSvg = d3.select(".bird-plugin-container")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%");

        var zoomData = data.zoom;

        var svgWidth = parseInt(minimapSvg.style("width"));
        var svgHeight = parseInt(minimapSvg.style("height"));

        // Find the bounding box of the nodes
        var minX = d3.min(data.nodes, function (d) {
            return d.x;
        });
        var maxX = d3.max(data.nodes, function (d) {
            return d.x;
        });
        var minY = d3.min(data.nodes, function (d) {
            return d.y;
        });
        var maxY = d3.max(data.nodes, function (d) {
            return d.y;
        });

        // Calculate the width and height of the bounding box
        var width = maxX - minX;
        var height = maxY - minY;

        // Calculate the scale factor to fit the bounding box within the minimap
        var scaleFactor = Math.min(svgWidth / width, svgHeight / height);

        // Calculate the translation to center the bounding box within the minimap
        var translateX = -minX * scaleFactor + (svgWidth - width * scaleFactor) / 2;
        var translateY = -minY * scaleFactor + (svgHeight - height * scaleFactor) / 2;

        // Apply the scale and translation to the minimap
        var g = minimapSvg.append("g")
            .attr("transform", "translate(" + translateX + "," + translateY + ") scale(" + scaleFactor + ")");

        // Draw nodes
        g.selectAll(".node")
            .data(data.nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr("cx", function (d) {
                return d.x;
            })
            .attr("cy", function (d) {
                return d.y;
            })
            .attr("r", function (d) {
                return d.radius;
            })
            .style("fill", "blue");

        // Draw edges
        g.selectAll(".link")
            .data(data.edges)
            .enter().append("line")
            .attr("class", "link")
            .attr("x1", function (d) {
                return data.nodes[d.source].x;
            })
            .attr("y1", function (d) {
                return data.nodes[d.source].y;
            })
            .attr("x2", function (d) {
                return data.nodes[d.target].x;
            })
            .attr("y2", function (d) {
                return data.nodes[d.target].y;
            })
            .style("stroke", "black")
            .style("stroke-width", 2);

        // Draw viewport rectangle
        drawViewportRect(zoomData);
    }

    function drawViewportRect(transform) {
        // Get the dimensions of the main SVG container
        var svgWidth = parseInt(d3.select(".container-simple").style("width"));
        var svgHeight = parseInt(d3.select(".container-simple").style("height"));

        // Calculate the scale factor based on the zoom transformation
        var scaleFactor = transform.k;

        // Calculate the visible area (viewport) of the main graph
        var visibleWidth = svgWidth / scaleFactor;
        var visibleHeight = svgHeight / scaleFactor;
        var visibleX = -transform.x / scaleFactor;
        var visibleY = -transform.y / scaleFactor;

        var g = d3.select(".bird-plugin-container svg g");

        viewportRect = g.append("rect")
            .attr("class", "viewport-rect")
            .attr("x", visibleX)
            .attr("y", visibleY)
            .attr("width", visibleWidth)
            .attr("height", visibleHeight)
            .style("fill", "none")
            .style("stroke", "red")
            .style("stroke-width", 5);
    }

</script>

</body>
</html>
